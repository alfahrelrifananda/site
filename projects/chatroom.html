<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Room</title>
    <link rel="icon" href="data:image/svg+xml;utf8,
    <svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'>
      <rect width='100%' height='100%' fill='%23ffffff'/>
      <text x='50%' y='50%' font-family='Arial, sans-serif' font-weight='700' font-size='36'
            fill='%23000000' dominant-baseline='middle' text-anchor='middle'>AR</text>
    </svg>">
    <link rel="stylesheet" href="../style.css">
</head>
<body>
    <h1>Chat Room</h1>
    
    <div id="messages">
        <p id="loading">Loading...</p>
    </div>
    
    <hr>
    
    <input type="text" id="messageInput" placeholder="Type your message..." size="50">
    <button onclick="sendMessage()">Send</button>
    
    <hr>
    
    <p>Your ID: <strong id="userId"></strong></p>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, push, onChildAdded, onValue, set, onDisconnect, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';
        import firebaseConfig from '../config.js';

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        const userId = 'User' + Math.floor(Math.random() * 10000);
        document.getElementById('userId').textContent = userId;

        const userRef = ref(db, 'presence/' + userId);
        set(userRef, { online: true, timestamp: serverTimestamp() });
        onDisconnect(userRef).remove();

        const messagesRef = ref(db, 'messages');
        let firstLoad = true;
        onChildAdded(messagesRef, (snapshot) => {
            const msg = snapshot.val();
            
            if (firstLoad) {
                const loadingEl = document.getElementById('loading');
                if (loadingEl) loadingEl.remove();
                firstLoad = false;
            }
            
            displayMessage(msg);
        });

        window.sendMessage = function() {
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            
            if (text === '') return;

            push(messagesRef, {
                user: userId,
                text: text,
                timestamp: serverTimestamp()
            });

            input.value = '';
        };

        function displayMessage(msg) {
            const messagesDiv = document.getElementById('messages');
            const msgDiv = document.createElement('div');
            
            const time = msg.timestamp ? new Date(msg.timestamp).toLocaleTimeString() : 'now';
            msgDiv.innerHTML = `<strong>${msg.user}</strong> [${time}]: ${escapeHtml(msg.text)}`;
            
            messagesDiv.appendChild(msgDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        document.getElementById('messageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
    </script>
</body>
</html>